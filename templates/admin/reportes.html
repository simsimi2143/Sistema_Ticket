{% extends "base.html" %}

{% block title %}Reportes - Sistema de Tickets{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">游늵 Generaci칩n de Reportes</h1>
        <p class="text-gray-600 mt-2">Genera reportes detallados con gr치ficos y an치lisis</p>
    </div>

    <!-- Tarjetas de Reportes -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Reporte por Usuario -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            <div class="bg-gradient-to-r from-blue-600 to-blue-400 p-6">
                <i class="fas fa-users text-white text-4xl mb-3"></i>
                <h2 class="text-2xl font-bold text-white">Reporte por Usuario</h2>
                <p class="text-blue-100 mt-2">An치lisis de tickets por usuario con m칠tricas detalladas</p>
            </div>
            <div class="p-6">
                <ul class="space-y-2 mb-6">
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Gr치fico de distribuci칩n por estado
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Top 10 usuarios m치s activos
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Listado detallado de tickets
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        M칠tricas globales del sistema
                    </li>
                </ul>
                <div class="flex space-x-3">
                    <button onclick="mostrarVistaPrevia('usuarios')" 
                            class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-3 px-4 rounded inline-flex items-center justify-center">
                        <i class="fas fa-eye mr-2"></i> Vista Previa
                    </button>
                    <a href="{{ url_for('main.generar_reporte_usuarios_download') }}" 
                       class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded inline-flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Descargar
                    </a>
                </div>
            </div>
        </div>

        <!-- Reporte por Departamento -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            <div class="bg-gradient-to-r from-purple-600 to-purple-400 p-6">
                <i class="fas fa-building text-white text-4xl mb-3"></i>
                <h2 class="text-2xl font-bold text-white">Reporte por Departamento</h2>
                <p class="text-purple-100 mt-2">An치lisis de tickets por 치rea organizacional</p>
            </div>
            <div class="p-6">
                <ul class="space-y-2 mb-6">
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Gr치fico de distribuci칩n por estado
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Comparativa entre departamentos
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Porcentajes y estad칤sticas
                    </li>
                    <li class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        An치lisis de carga de trabajo
                    </li>
                </ul>
                <div class="flex space-x-3">
                    <button onclick="mostrarVistaPrevia('departamentos')" 
                            class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-3 px-4 rounded inline-flex items-center justify-center">
                        <i class="fas fa-eye mr-2"></i> Vista Previa
                    </button>
                    <a href="{{ url_for('main.generar_reporte_departamentos_download') }}" 
                       class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded inline-flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Descargar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci칩n adicional -->
    <div class="mt-8 bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400 text-xl"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Informaci칩n sobre los reportes</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <ul class="list-disc list-inside space-y-1">
                        <li>Los reportes se generan en formato PDF con gr치ficos profesionales</li>
                        <li>La vista previa muestra un resumen de los datos principales</li>
                        <li>Los archivos PDF incluyen informaci칩n completa y detallada</li>
                        <li>Los gr치ficos utilizan colores corporativos para mejor visualizaci칩n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Vista Previa de Reportes -->
<div id="modalVistaPrevia" class="fixed inset-0 bg-gray-900 bg-opacity-50 modal-backdrop hidden overflow-y-auto h-full w-full">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-2xl rounded-lg bg-white mb-10">
        <!-- Header del Modal -->
        <div class="flex justify-between items-center pb-4 border-b-2 border-gray-200">
            <h3 class="text-2xl font-bold text-gray-800" id="modalTitulo">
                <i class="fas fa-chart-line mr-2"></i>Vista Previa del Reporte
            </h3>
            <button onclick="cerrarModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-3xl"></i>
            </button>
        </div>
        
        <!-- Contenido del Modal -->
        <div class="mt-6">
            <!-- Loading -->
            <div id="loadingPreview" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                <p class="text-lg text-gray-600">Cargando vista previa...</p>
            </div>
            
            <!-- Contenido de la Vista Previa -->
            <div id="contenidoPreview" class="hidden">
                <!-- M칠tricas Globales -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg mb-6 border border-blue-200">
                    <h4 class="font-bold text-xl mb-4 text-gray-800">
                        <i class="fas fa-chart-pie mr-2"></i>M칠tricas Globales
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <p class="text-gray-600 text-sm font-medium mb-1">Total Tickets</p>
                            <p class="text-3xl font-bold text-blue-600" id="metrica-total">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <p class="text-gray-600 text-sm font-medium mb-1">Abiertos</p>
                            <p class="text-3xl font-bold text-yellow-600" id="metrica-abiertos">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <p class="text-gray-600 text-sm font-medium mb-1">Cerrados</p>
                            <p class="text-3xl font-bold text-green-600" id="metrica-cerrados">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <p class="text-gray-600 text-sm font-medium mb-1">En Progreso</p>
                            <p class="text-3xl font-bold text-orange-600" id="metrica-progreso">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Datos -->
                <div class="bg-white rounded-lg overflow-hidden shadow-lg border border-gray-200">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gradient-to-r from-gray-100 to-gray-200 sticky top-0">
                                <tr id="tablaHeader">
                                    <!-- Se llenar치 din치micamente -->
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="tablaBody">
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Nota:</strong> Vista previa limitada a los primeros registros. 
                        El PDF completo incluye todos los datos, gr치ficos detallados y an치lisis estad칤sticos.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Footer del Modal -->
        <div class="flex justify-end space-x-3 pt-6 border-t-2 border-gray-200 mt-6">
            <button onclick="cerrarModal()" 
                    class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                <i class="fas fa-times mr-2"></i>Cancelar
            </button>
            <button id="btnDescargarPDF" onclick="descargarPDF()" 
                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2 px-6 rounded-lg inline-flex items-center transition-all shadow-md hover:shadow-lg">
                <i class="fas fa-download mr-2"></i> Descargar PDF Completo
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// FUNCIONALIDAD DEL MODAL DE REPORTES
// ============================================

let tipoReporteActual = '';

function mostrarVistaPrevia(tipo) {
    tipoReporteActual = tipo;
    const modal = document.getElementById('modalVistaPrevia');
    const loading = document.getElementById('loadingPreview');
    const contenido = document.getElementById('contenidoPreview');
    const titulo = document.getElementById('modalTitulo');
    
    // Mostrar modal y loading
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Evitar scroll del body
    loading.classList.remove('hidden');
    contenido.classList.add('hidden');
    
    // Actualizar t칤tulo
    if (tipo === 'usuarios') {
        titulo.innerHTML = '<i class="fas fa-user-friends mr-2"></i>Vista Previa - Reporte por Usuario';
    } else {
        titulo.innerHTML = '<i class="fas fa-building mr-2"></i>Vista Previa - Reporte por Departamento';
    }
    
    // Cargar datos
    const url = tipo === 'usuarios' 
        ? '/admin/reportes/usuarios/preview'
        : '/admin/reportes/departamentos/preview';
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar los datos');
            }
            return response.json();
        })
        .then(data => {
            mostrarDatos(data, tipo);
            loading.classList.add('hidden');
            contenido.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar la vista previa. Por favor, intente nuevamente.');
            cerrarModal();
        });
}

function mostrarDatos(data, tipo) {
    // Actualizar m칠tricas
    document.getElementById('metrica-total').textContent = data.metricas.total;
    document.getElementById('metrica-abiertos').textContent = data.metricas.abiertos;
    document.getElementById('metrica-cerrados').textContent = data.metricas.cerrados;
    
    // Calcular en progreso
    const enProgreso = data.metricas.por_estado.find(e => e[0] === 'En Progreso');
    document.getElementById('metrica-progreso').textContent = enProgreso ? enProgreso[1] : 0;
    
    // Llenar tabla
    const header = document.getElementById('tablaHeader');
    const body = document.getElementById('tablaBody');
    
    if (tipo === 'usuarios') {
        // SOLO 4 COLUMNAS: Usuario, Departamento, Tickets Creados, Tickets Asignados
        header.innerHTML = `
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-user mr-1"></i>Usuario
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-building mr-1"></i>Departamento
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-plus-circle text-blue-600 mr-1"></i>Tickets Creados
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-user-check text-green-600 mr-1"></i>Tickets Asignados
            </th>
        `;
        
        body.innerHTML = data.usuarios.map((u, index) => {
            // Manejar el caso de departamento nulo
            const deptoName = u.usuario.departamento && u.usuario.departamento.depth_name 
                ? u.usuario.departamento.depth_name 
                : '<span class="text-gray-400 italic">Sin departamento</span>';
            
            return `
            <tr class="hover:bg-blue-50 transition-colors ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-blue-600 text-sm"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">${u.usuario.name}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    ${deptoName}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full bg-blue-100 text-blue-800">
                        <i class="fas fa-plus-circle mr-1"></i>${u.total_creados || 0}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full bg-green-100 text-green-800">
                        <i class="fas fa-user-check mr-1"></i>${u.total_asignados || 0}
                    </span>
                </td>
            </tr>
            `;
        }).join('');
        
        if (data.total_usuarios > 10) {
            body.innerHTML += `
                <tr class="bg-yellow-50">
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-700">
                        <i class="fas fa-ellipsis-h mr-2"></i>
                        <strong>... y ${data.total_usuarios - 10} usuarios m치s en el PDF completo</strong>
                    </td>
                </tr>
            `;
        }
    } else {
        // Reporte por departamento (mantiene 4 columnas pero con diferentes nombres)
        header.innerHTML = `
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">#</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-building mr-1"></i>Departamento
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-ticket-alt mr-1"></i>Cantidad de Tickets
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                <i class="fas fa-percentage mr-1"></i>Porcentaje
            </th>
        `;
        
        const total = data.departamentos.reduce((sum, d) => sum + d.cantidad, 0);
        
        body.innerHTML = data.departamentos.map((d, i) => {
            const porcentaje = total > 0 ? ((d.cantidad / total) * 100).toFixed(1) : 0;
            const bgColor = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
            return `
                <tr class="hover:bg-purple-50 transition-colors ${bgColor}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-500">${i + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-purple-600 text-sm"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">${d.nombre}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-4 py-2 inline-flex text-sm leading-5 font-bold rounded-full bg-green-100 text-green-800">
                            ${d.cantidad}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-3 mr-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" 
                                     style="width: ${porcentaje}%"></div>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">${porcentaje}%</span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        if (data.total_departamentos > 10) {
            body.innerHTML += `
                <tr class="bg-yellow-50">
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-700">
                        <i class="fas fa-ellipsis-h mr-2"></i>
                        <strong>... y ${data.total_departamentos - 10} departamentos m치s en el PDF completo</strong>
                    </td>
                </tr>
            `;
        }
    }
}

function descargarPDF() {
    const url = tipoReporteActual === 'usuarios'
        ? '/admin/reportes/usuarios/generar'
        : '/admin/reportes/departamentos/generar';
    
    window.location.href = url;
}

function cerrarModal() {
    document.getElementById('modalVistaPrevia').classList.add('hidden');
    document.body.style.overflow = 'auto'; // Restaurar scroll del body
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalVistaPrevia').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModal();
    }
});

// Cerrar modal con tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalVistaPrevia');
        if (!modal.classList.contains('hidden')) {
            cerrarModal();
        }
    }
});
</script>
{% endblock %}